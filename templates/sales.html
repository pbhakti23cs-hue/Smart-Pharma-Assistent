{% extends "base.html" %}

{% block title %}Sales History - Smart Pharma Assistant{% endblock %}

{% block extra_css %}
<style>
    /* Main Container */
    .sales-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 0;
        min-height: 70vh;
    }
    
    /* Header */
    .sales-header {
        background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        color: white;
        padding: 35px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: 0 15px 35px rgba(21, 101, 192, 0.25);
        position: relative;
        overflow: hidden;
        border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .sales-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 250px;
        height: 250px;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 25px 25px;
        opacity: 0.3;
        animation: floatBackground 20s linear infinite;
    }
    
    @keyframes floatBackground {
        0% { transform: translate(0, 0) rotate(0deg); }
        100% { transform: translate(30px, 30px) rotate(360deg); }
    }
    
    .sales-header h1 {
        font-size: 2.2rem;
        margin-bottom: 15px;
        font-weight: 700;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .sales-header p {
        opacity: 0.9;
        font-weight: 300;
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
        max-width: 700px;
        margin: 0 auto;
        line-height: 1.6;
    }
    
    /* Main Content */
    .sales-content {
        background: white;
        border-radius: 0 0 15px 15px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(156, 39, 176, 0.1);
    }
    
    /* Filters Section */
    .filters-section {
        background: #F9F9F9;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border: 2px solid #E0E0E0;
    }
    
    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .filters-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #7B1FA2;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 8px 16px;
        background: white;
        border: 2px solid #9C27B0;
        color: #9C27B0;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .filter-btn:hover {
        background: #9C27B0;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(156, 39, 176, 0.2);
    }
    
    .filter-btn.active {
        background: #9C27B0;
        color: white;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    /* Fix for date range - make it take full width */
    .filter-group:first-child {
        grid-column: 1 / -1;
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
        background: white;
    }
    
    .filter-input:focus {
        outline: none;
        border-color: #9C27B0;
        box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.1);
    }
    
    /* Date range specific styling */
    .date-range-container {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 15px;
        align-items: center;
        width: 100%;
    }
    
    .date-range-container span {
        text-align: center;
        color: #666;
        font-weight: 600;
        padding: 0 10px;
        white-space: nowrap;
    }
    
    .apply-filters-btn {
        grid-column: 1 / -1;
        padding: 15px;
        background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
    }
    
    .apply-filters-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(156, 39, 176, 0.3);
    }
    
    /* Summary Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }
    
    .summary-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }
    
    .summary-card.revenue { border-top: 6px solid #4CAF50; }
    .summary-card.sales { border-top: 6px solid #2196F3; }
    .summary-card.customers { border-top: 6px solid #FF9800; }
    .summary-card.average { border-top: 6px solid #9C27B0; }
    
    .summary-icon {
        font-size: 2.5rem;
        margin-bottom: 20px;
        opacity: 0.9;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
    }
    
    .summary-card.revenue .summary-icon { color: #4CAF50; }
    .summary-card.sales .summary-icon { color: #2196F3; }
    .summary-card.customers .summary-icon { color: #FF9800; }
    .summary-card.average .summary-icon { color: #9C27B0; }
    
    .summary-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }
    
    .summary-value {
        font-size: 2.2rem;
        font-weight: 900;
        line-height: 1;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--color), var(--color-light));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .summary-card.revenue .summary-value { --color: #4CAF50; --color-light: #81C784; }
    .summary-card.sales .summary-value { --color: #2196F3; --color-light: #64B5F6; }
    .summary-card.customers .summary-value { --color: #FF9800; --color-light: #FFB74D; }
    .summary-card.average .summary-value { --color: #9C27B0; --color-light: #BA68C8; }
    
    .summary-label {
        font-size: 1rem;
        color: #666;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .summary-trend {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 5px 10px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.5);
    }
    
    .trend-up { 
        color: #4CAF50; 
        background: rgba(76, 175, 80, 0.1); 
    }
    .trend-down { 
        color: #F44336; 
        background: rgba(244, 67, 54, 0.1); 
    }
    .trend-neutral { 
        color: #FF9800; 
        background: rgba(255, 152, 0, 0.1); 
    }
    
    /* Sales Table */
    .sales-table-section {
        margin-top: 40px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #E0E0E0;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #7B1FA2;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .table-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .search-box {
        position: relative;
    }
    
    .search-input {
        padding: 10px 15px 10px 40px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 14px;
        width: 250px;
        transition: all 0.3s;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #9C27B0;
        box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.1);
    }
    
    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #9C27B0;
    }
    
    .export-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);
    }
    
    /* Table Styles */
    .sales-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
        border: 1px solid #E0E0E0;
    }
    
    .sales-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    
    .sales-table thead {
        background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    }
    
    .sales-table th {
        padding: 18px 15px;
        color: white;
        font-weight: 700;
        text-align: left;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        border-bottom: 3px solid rgba(255, 255, 255, 0.1);
    }
    
    .sales-table tbody tr {
        border-bottom: 1px solid #F0F0F0;
        transition: all 0.3s;
    }
    
    .sales-table tbody tr:hover {
        background: #F9F9F9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .sales-table td {
        padding: 18px 15px;
        vertical-align: middle;
        color: #333;
    }
    
    .receipt-number {
        font-weight: 700;
        color: #9C27B0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .customer-info {
        max-width: 200px;
    }
    
    .customer-name {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
    }
    
    .customer-phone {
        font-size: 0.85rem;
        color: #666;
    }
    
    .medicine-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .medicine-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #E1BEE7, #CE93D8);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #7B1FA2;
        font-size: 1.2rem;
    }
    
    .medicine-details {
        flex: 1;
    }
    
    .medicine-name {
        font-weight: 600;
        margin-bottom: 3px;
        color: #333;
    }
    
    .medicine-quantity {
        font-size: 0.85rem;
        color: #666;
    }
    
    .amount {
        font-weight: 700;
        color: #4CAF50;
        font-size: 1.1rem;
    }
    
    .date-time {
        color: #666;
        font-size: 0.9rem;
    }
    
    .payment-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    
    .payment-cash { background: #E8F5E9; color: #2E7D32; }
    .payment-card { background: #E3F2FD; color: #1565C0; }
    .payment-upi { background: #F3E5F5; color: #7B1FA2; }
    .payment-insurance { background: #FFF3E0; color: #EF6C00; }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .action-btn.view {
        background: #E3F2FD;
        color: #1565C0;
    }
    
    .action-btn.view:hover {
        background: #1565C0;
        color: white;
    }
    
    .action-btn.print {
        background: #FFF3E0;
        color: #EF6C00;
    }
    
    .action-btn.print:hover {
        background: #EF6C00;
        color: white;
    }
    
    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
        padding: 20px;
        border-top: 2px solid #F0F0F0;
    }
    
    .pagination-btn {
        padding: 10px 16px;
        background: white;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .pagination-btn:hover:not(:disabled) {
        border-color: #9C27B0;
        color: #9C27B0;
        transform: translateY(-2px);
    }
    
    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pagination-pages {
        display: flex;
        gap: 5px;
    }
    
    .page-number {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
    }
    
    .page-number:hover {
        border-color: #9C27B0;
        color: #9C27B0;
    }
    
    .page-number.active {
        background: #9C27B0;
        color: white;
        border-color: #9C27B0;
    }
    
    .items-per-page {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: auto;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .date-range-container {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .date-range-container span {
            display: none;
        }
    }
    
    @media (max-width: 768px) {
        .sales-header {
            padding: 25px 20px;
        }
        
        .sales-content {
            padding: 25px;
        }
        
        .summary-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        /* Reset grid-column for date range on mobile */
        .filter-group:first-child {
            grid-column: 1;
        }
        
        .search-input {
            width: 100%;
        }
        
        .table-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .sales-table-container {
            overflow-x: auto;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 5px;
        }
        
        .pagination {
            flex-wrap: wrap;
        }
        
        .items-per-page {
            margin-left: 0;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }
        
        .filters-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .filter-buttons {
            justify-content: center;
        }
    }
    
    @media (max-width: 480px) {
        .sales-header h1 {
            font-size: 1.8rem;
        }
        
        .filter-buttons {
            flex-direction: column;
            width: 100%;
        }
        
        .filter-btn {
            width: 100%;
            justify-content: center;
        }
        
        .summary-value {
            font-size: 1.8rem;
        }
        
        .date-range-container {
            grid-template-columns: 1fr;
        }
    }
    
    /* Loading Animation */
    .loading {
        position: relative;
        overflow: hidden;
    }
    
    .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .empty-state h3 {
        color: #666;
        margin-bottom: 10px;
        font-size: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="sales-container slide-in">
    <!-- Header -->
    <div class="sales-header">
        <h1><i class="fas fa-chart-line"></i> Sales History & Reports</h1>
        
    </div>
    
    <!-- Main Content -->
    <div class="sales-content">
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-header">
                <h2 class="filters-title">
                    <i class="fas fa-filter"></i> Filter Sales
                </h2>
                <div class="filter-buttons">
                    <button class="filter-btn {% if period == 'today' or not period %}active{% endif %}" data-period="today">
                        <i class="fas fa-calendar-day"></i> Today
                    </button>
                    <button class="filter-btn {% if period == 'week' %}active{% endif %}" data-period="week">
                        <i class="fas fa-calendar-week"></i> This Week
                    </button>
                    <button class="filter-btn {% if period == 'month' %}active{% endif %}" data-period="month">
                        <i class="fas fa-calendar-alt"></i> This Month
                    </button>
                    <button class="filter-btn {% if period == 'year' %}active{% endif %}" data-period="year">
                        <i class="fas fa-calendar"></i> This Year
                    </button>
                    <button class="filter-btn {% if period == 'all' %}active{% endif %}" data-period="all">
                        <i class="fas fa-infinity"></i> All Time
                    </button>
                </div>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-calendar"></i> Date Range
                    </label>
                    <div class="date-range-container">
                        <input type="date" id="startDate" class="filter-input" 
                               value="{{ start_date if start_date else now.strftime('%Y-%m-%d') }}">
                        <span>to</span>
                        <input type="date" id="endDate" class="filter-input" 
                               value="{{ end_date if end_date else now.strftime('%Y-%m-%d') }}">
                    </div>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-user"></i> Customer
                    </label>
                    <input type="text" id="customerFilter" class="filter-input" 
                           placeholder="Search by customer name or phone"
                           value="{{ customer if customer else '' }}">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-pills"></i> Medicine
                    </label>
                    <input type="text" id="medicineFilter" class="filter-input" 
                           placeholder="Search by medicine name"
                           value="{{ medicine if medicine else '' }}">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-credit-card"></i> Payment Method
                    </label>
                    <select id="paymentFilter" class="filter-input">
                        <option value="">All Methods</option>
                        <option value="cash" {% if payment_method == 'cash' %}selected{% endif %}>Cash</option>
                        <option value="card" {% if payment_method == 'card' %}selected{% endif %}>Card</option>
                        <option value="upi" {% if payment_method == 'upi' %}selected{% endif %}>UPI</option>
                        <option value="insurance" {% if payment_method == 'insurance' %}selected{% endif %}>Insurance</option>
                    </select>
                </div>
                
                <button class="apply-filters-btn" id="applyFilters">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card revenue">
                <div class="summary-icon">
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="summary-content">
                    <div>
                        <div class="summary-label">Total Revenue</div>
                        <div class="summary-value" id="totalRevenue">₹{{ summary.total_revenue if summary.total_revenue else "0.00" }}</div>
                    </div>
                    <div class="summary-trend trend-up">
                        <i class="fas fa-arrow-up"></i> 24% this month
                    </div>
                </div>
            </div>
            
            <div class="summary-card sales">
                <div class="summary-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="summary-content">
                    <div>
                        <div class="summary-label">Total Sales</div>
                        <div class="summary-value" id="totalSales">{{ summary.total_sales if summary.total_sales else "0" }}</div>
                    </div>
                    <div class="summary-trend trend-up">
                        <i class="fas fa-arrow-up"></i> 18% growth
                    </div>
                </div>
            </div>
            
            <div class="summary-card customers">
                <div class="summary-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="summary-content">
                    <div>
                        <div class="summary-label">Customers Today</div>
                        <div class="summary-value" id="totalCustomers">{{ summary.unique_customers if summary.unique_customers else "0" }}</div>
                    </div>
                    <div class="summary-trend trend-neutral">
                        <i class="fas fa-minus"></i> Steady
                    </div>
                </div>
            </div>
            
            <div class="summary-card average">
                <div class="summary-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="summary-content">
                    <div>
                        <div class="summary-label">Avg Transaction</div>
                        <div class="summary-value" id="avgTransaction">₹{{ "%.2f"|format(summary.avg_transaction) if summary.avg_transaction else "0.00" }}</div>
                    </div>
                    <div class="summary-trend trend-up">
                        <i class="fas fa-arrow-up"></i> 12% increase
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sales Table -->
        <div class="sales-table-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> Recent Sales Transactions
                </h2>
                <div class="table-controls">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="tableSearch" class="search-input" placeholder="Search sales...">
                    </div>
                    <button class="export-btn" id="exportBtn">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            
            {% if sales %}
            <div class="sales-table-container">
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Receipt #</th>
                            <th style="min-width: 200px;">Customer</th>
                            <th style="min-width: 250px;">Medicine</th>
                            <th style="width: 120px;">Quantity</th>
                            <th style="width: 120px;">Amount</th>
                            <th style="width: 150px;">Date & Time</th>
                            <th style="width: 100px;">Payment</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        {% for sale in sales %}
                        <tr>
                            <td>
                                <div class="receipt-number">
                                    <i class="fas fa-receipt"></i>
                                    {{ sale.id }}
                                </div>
                            </td>
                            <td>
                                <div class="customer-info">
                                    <div class="customer-name">{{ sale.customer_name }}</div>
                                    <div class="customer-phone">{{ sale.customer_phone }}</div>
                                    {% if sale.customer_age %}
                                    <div class="customer-age" style="font-size: 0.85rem; color: #666;">Age: {{ sale.customer_age }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="medicine-info">
                                    <div class="medicine-icon">
                                        <i class="fas fa-capsules"></i>
                                    </div>
                                    <div class="medicine-details">
                                        <div class="medicine-name">{{ sale.medicine_name }}</div>
                                        <div class="medicine-quantity">Batch: {{ sale.batch_no }}</div>
                                        {% if sale.doctor_name %}
                                        <div class="doctor-name" style="font-size: 0.85rem; color: #666;">Dr. {{ sale.doctor_name }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="font-weight: 600; color: #2196F3;">{{ sale.quantity_sold }}</div>
                            </td>
                            <td>
                                <div class="amount">₹{{ "%.2f"|format(sale.quantity_sold * sale.selling_price) }}</div>
                                <div style="font-size: 0.85rem; color: #666;">₹{{ "%.2f"|format(sale.selling_price) }} each</div>
                            </td>
                            <td>
                                <div class="date-time">
                                    {% if sale.sold_on %}
                                        {% if 'T' in sale.sold_on|string %}
                                            {% set sold_date = sale.sold_on.split('T')[0] %}
                                            {% set sold_time = sale.sold_on.split('T')[1].split('.')[0] %}
                                        {% else %}
                                            {% set sold_date = sale.sold_on %}
                                            {% set sold_time = '' %}
                                        {% endif %}
                                        {{ sold_date }}<br>
                                        {% if sold_time %}
                                            <small>{{ sold_time }}</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if sale.payment_method %}
                                    <span class="payment-badge payment-{{ sale.payment_method }}">
                                        {{ sale.payment_method|upper }}
                                    </span>
                                {% else %}
                                    <span class="payment-badge payment-cash">
                                        CASH
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" data-id="{{ sale.id }}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="action-btn print" data-id="{{ sale.id }}">
                                        <i class="fas fa-print"></i> Print
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <button class="pagination-btn" id="prevPage" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                
                <div class="pagination-pages">
                    <span class="page-number active">1</span>
                </div>
                
                <button class="pagination-btn" id="nextPage" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
                
                <div class="items-per-page">
                    <span>Show:</span>
                    <select id="itemsPerPage" style="padding: 5px; border: 2px solid #E0E0E0; border-radius: 5px;">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-shopping-cart"></i>
                <h3>No Sales Found</h3>
                <p>Start selling medicines to see transactions here</p>
                <a href="{{ url_for('sell_medicine') }}" style="display: inline-block; margin-top: 20px; padding: 12px 25px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                    <i class="fas fa-cash-register"></i> Make Your First Sale
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Sale Details Modal -->
<div id="saleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; padding: 20px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-receipt"></i> Sale Details
            </h3>
            <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div style="padding: 30px;" id="modalContent">
            <!-- Content will be loaded here -->
        </div>
        <div style="padding: 20px; border-top: 2px solid #F0F0F0; text-align: center;">
            <button onclick="closeModal()" style="padding: 12px 30px; background: #9C27B0; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Close
            </button>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const filterBtns = document.querySelectorAll('.filter-btn');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const tableSearch = document.getElementById('tableSearch');
    const exportBtn = document.getElementById('exportBtn');
    const salesTableBody = document.getElementById('salesTableBody');
    const saleModal = document.getElementById('saleModal');
    const modalContent = document.getElementById('modalContent');
    
    // Filter period buttons
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update date range based on period
            updateDateRange(this.getAttribute('data-period'));
        });
    });
    
    // Update date range based on period
    function updateDateRange(period) {
        const now = new Date();
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        switch(period) {
            case 'today':
                startDateInput.value = now.toISOString().split('T')[0];
                endDateInput.value = now.toISOString().split('T')[0];
                break;
            case 'week':
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                startDateInput.value = weekStart.toISOString().split('T')[0];
                endDateInput.value = now.toISOString().split('T')[0];
                break;
            case 'month':
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                startDateInput.value = monthStart.toISOString().split('T')[0];
                endDateInput.value = now.toISOString().split('T')[0];
                break;
            case 'year':
                const yearStart = new Date(now.getFullYear(), 0, 1);
                startDateInput.value = yearStart.toISOString().split('T')[0];
                endDateInput.value = now.toISOString().split('T')[0];
                break;
            case 'all':
                startDateInput.value = '2020-01-01';
                endDateInput.value = now.toISOString().split('T')[0];
                break;
        }
    }
    
    // Apply filters - THE KEY FIX
    applyFiltersBtn.addEventListener('click', function() {
        // Get filter values
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const customer = document.getElementById('customerFilter').value;
        const medicine = document.getElementById('medicineFilter').value;
        const payment = document.getElementById('paymentFilter').value;
        
        // Get active period
        let period = 'today';
        filterBtns.forEach(btn => {
            if (btn.classList.contains('active')) {
                period = btn.getAttribute('data-period');
            }
        });
        
        // Build URL with query parameters
        let url = `/sales?period=${period}`;
        
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;
        if (customer) url += `&customer=${encodeURIComponent(customer)}`;
        if (medicine) url += `&medicine=${encodeURIComponent(medicine)}`;
        if (payment) url += `&payment_method=${payment}`;
        
        // Show loading state
        applyFiltersBtn.classList.add('loading');
        applyFiltersBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        
        // Redirect to filtered URL - this will reload the page with filtered data
        window.location.href = url;
    });
    
    // Table search - Real-time filtering of displayed rows
    tableSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = salesTableBody.querySelectorAll('tr');
        let hasVisibleRows = false;
        
        rows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            if (rowText.includes(searchTerm)) {
                row.style.display = '';
                hasVisibleRows = true;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show empty state if no results
        if (!hasVisibleRows && rows.length > 0) {
            showEmptyState('No results found for your search');
        }
    });
    
    // Export button
    exportBtn.addEventListener('click', function() {
        exportBtn.classList.add('loading');
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        
        // Get current filter values for export
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const customer = document.getElementById('customerFilter').value;
        const medicine = document.getElementById('medicineFilter').value;
        const payment = document.getElementById('paymentFilter').value;
        
        let period = 'today';
        filterBtns.forEach(btn => {
            if (btn.classList.contains('active')) {
                period = btn.getAttribute('data-period');
            }
        });
        
        // Build export URL
        let exportUrl = `/api/sales/export?period=${period}`;
        if (startDate) exportUrl += `&start_date=${startDate}`;
        if (endDate) exportUrl += `&end_date=${endDate}`;
        if (customer) exportUrl += `&customer=${encodeURIComponent(customer)}`;
        if (medicine) exportUrl += `&medicine=${encodeURIComponent(medicine)}`;
        if (payment) exportUrl += `&payment_method=${payment}`;
        
        // Trigger download
        const link = document.createElement('a');
        link.href = exportUrl;
        link.download = 'sales_report_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Reset button state
        setTimeout(() => {
            exportBtn.classList.remove('loading');
            exportBtn.innerHTML = '<i class="fas fa-file-export"></i> Export';
            showNotification('Export started successfully', 'success');
        }, 1000);
    });
    
    // View sale details
    document.querySelectorAll('.action-btn.view').forEach(btn => {
        btn.addEventListener('click', function() {
            const saleId = this.getAttribute('data-id');
            showSaleDetails(saleId);
        });
    });
    
    // Print receipt
    document.querySelectorAll('.action-btn.print').forEach(btn => {
        btn.addEventListener('click', function() {
            const saleId = this.getAttribute('data-id');
            printReceipt(saleId);
        });
    });
    
    // Show sale details modal
    function showSaleDetails(saleId) {
        modalContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: #9C27B0;"></i>
                <p style="margin-top: 15px;">Loading sale details...</p>
            </div>
        `;
        
        saleModal.style.display = 'flex';
        
        // Fetch sale details from server
        fetch(`/api/sales/${saleId}`)
            .then(response => response.json())
            .then(saleData => {
                if (saleData.error) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #F44336;">
                            <i class="fas fa-exclamation-triangle fa-3x"></i>
                            <h3 style="margin-top: 20px;">Error</h3>
                            <p>${saleData.error}</p>
                        </div>
                    `;
                    return;
                }
                
                // Format date and time
                let saleDate = 'N/A';
                let saleTime = '';
                if (saleData.sold_on) {
                    const dateObj = new Date(saleData.sold_on);
                    saleDate = dateObj.toLocaleDateString();
                    saleTime = dateObj.toLocaleTimeString();
                }
                
                modalContent.innerHTML = `
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #9C27B0; margin: 0;">
                                <i class="fas fa-receipt"></i> Receipt #${saleData.id}
                            </h4>
                            <span style="background: #4CAF50; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">
                                COMPLETED
                            </span>
                        </div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">
                            Date: ${saleDate}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            Time: ${saleTime}
                        </div>
                    </div>
                    
                    <div style="background: #F9F9F9; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                        <h5 style="margin-top: 0; margin-bottom: 15px; color: #333;">
                            <i class="fas fa-user"></i> Customer Information
                        </h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: 600; color: #666; font-size: 0.9rem;">Name</div>
                                <div style="font-size: 1.1rem; margin-top: 5px;">${saleData.customer_name || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #666; font-size: 0.9rem;">Phone</div>
                                <div style="font-size: 1.1rem; margin-top: 5px;">${saleData.customer_phone || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #666; font-size: 0.9rem;">Age</div>
                                <div style="font-size: 1.1rem; margin-top: 5px;">${saleData.customer_age || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #666; font-size: 0.9rem;">Prescription</div>
                                <div style="font-size: 1.1rem; margin-top: 5px;">${saleData.prescription_number || 'N/A'}</div>
                            </div>
                        </div>
                        ${saleData.doctor_name ? `
                        <div style="margin-top: 15px;">
                            <div style="font-weight: 600; color: #666; font-size: 0.9rem;">Doctor</div>
                            <div style="font-size: 1.1rem; margin-top: 5px;">Dr. ${saleData.doctor_name}</div>
                        </div>
                        ` : ''}
                        ${saleData.diagnosis ? `
                        <div style="margin-top: 15px;">
                            <div style="font-weight: 600; color: #666; font-size: 0.9rem;">Diagnosis</div>
                            <div style="font-size: 1.1rem; margin-top: 5px;">${saleData.diagnosis}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #F9F9F9; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                        <h5 style="margin-top: 0; margin-bottom: 15px; color: #333;">
                            <i class="fas fa-shopping-cart"></i> Items Purchased
                        </h5>
                        <div style="background: white; border-radius: 8px; overflow: hidden;">
                            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; padding: 15px; background: #E3F2FD; font-weight: 600; color: #1565C0;">
                                <div>Medicine</div>
                                <div>Qty</div>
                                <div>Price</div>
                                <div>Total</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; padding: 15px; border-bottom: 1px solid #F0F0F0;">
                                <div>
                                    <div style="font-weight: 600;">${saleData.medicine_name || 'N/A'}</div>
                                    <div style="font-size: 0.85rem; color: #666;">Batch: ${saleData.batch_no || 'N/A'}</div>
                                </div>
                                <div>${saleData.quantity_sold || 0}</div>
                                <div>₹${(saleData.selling_price || 0).toFixed(2)}</div>
                                <div style="font-weight: 600; color: #4CAF50;">₹${((saleData.quantity_sold || 0) * (saleData.selling_price || 0)).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #F9F9F9; border-radius: 10px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Subtotal:</span>
                            <span>₹${((saleData.quantity_sold || 0) * (saleData.selling_price || 0)).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Tax (5%):</span>
                            <span>₹${(((saleData.quantity_sold || 0) * (saleData.selling_price || 0)) * 0.05).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.2rem; color: #9C27B0; border-top: 2px dashed #E0E0E0; padding-top: 15px; margin-top: 10px;">
                            <span>Total Amount:</span>
                            <span>₹${(((saleData.quantity_sold || 0) * (saleData.selling_price || 0)) * 1.05).toFixed(2)}</span>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #E0E0E0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Payment Method:</span>
                                <span style="background: ${saleData.payment_method === 'cash' ? '#E8F5E9' : saleData.payment_method === 'card' ? '#E3F2FD' : saleData.payment_method === 'upi' ? '#F3E5F5' : '#FFF3E0'}; color: ${saleData.payment_method === 'cash' ? '#2E7D32' : saleData.payment_method === 'card' ? '#1565C0' : saleData.payment_method === 'upi' ? '#7B1FA2' : '#EF6C00'}; padding: 5px 15px; border-radius: 20px; font-weight: 600;">
                                    ${(saleData.payment_method || 'cash').toUpperCase()}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #F44336;">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <h3 style="margin-top: 20px;">Error</h3>
                        <p>Failed to load sale details: ${error.message}</p>
                    </div>
                `;
            });
    }
    
    // Close modal
    function closeModal() {
        saleModal.style.display = 'none';
    }
    
    // Print receipt
    function printReceipt(saleId) {
        // Fetch sale details first
        fetch(`/api/sales/${saleId}`)
            .then(response => response.json())
            .then(saleData => {
                if (saleData.error) {
                    showNotification('Failed to load receipt data', 'error');
                    return;
                }
                
                // Format date and time
                let saleDate = 'N/A';
                let saleTime = '';
                if (saleData.sold_on) {
                    const dateObj = new Date(saleData.sold_on);
                    saleDate = dateObj.toLocaleDateString();
                    saleTime = dateObj.toLocaleTimeString();
                }
                
                const totalAmount = ((saleData.quantity_sold || 0) * (saleData.selling_price || 0)) * 1.05;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Receipt #${saleData.id}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .receipt { max-width: 400px; margin: 0 auto; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .title { font-size: 24px; font-weight: bold; color: #9C27B0; }
                            .details { margin-bottom: 20px; }
                            .items { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            .items th { background: #f0f0f0; padding: 10px; text-align: left; }
                            .items td { padding: 10px; border-bottom: 1px solid #eee; }
                            .total { text-align: right; font-weight: bold; font-size: 18px; color: #9C27B0; }
                            .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
                            @media print { body { margin: 0; } .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="receipt">
                            <div class="header">
                                <div class="title">Smart Pharma Assistant</div>
                                <div>Receipt #${saleData.id}</div>
                                <div>${saleDate} ${saleTime}</div>
                            </div>
                            
                            <div class="details">
                                <div><strong>Customer:</strong> ${saleData.customer_name || 'N/A'}</div>
                                <div><strong>Phone:</strong> ${saleData.customer_phone || 'N/A'}</div>
                            </div>
                            
                            <table class="items">
                                <tr>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                                <tr>
                                    <td>${saleData.medicine_name || 'N/A'}</td>
                                    <td>${saleData.quantity_sold || 0}</td>
                                    <td>₹${(saleData.selling_price || 0).toFixed(2)}</td>
                                    <td>₹${((saleData.quantity_sold || 0) * (saleData.selling_price || 0)).toFixed(2)}</td>
                                </tr>
                            </table>
                            
                            <div class="total">Total: ₹${totalAmount.toFixed(2)}</div>
                            
                            <div class="footer">
                                <p>Thank you for your purchase!</p>
                                <p>For returns, bring this receipt within 7 days</p>
                                <p style="margin-top: 20px;">Powered by Smart Pharma Assistant</p>
                            </div>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 30px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Print Receipt
                            </button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                                Close
                            </button>
                        </div>
                        
                        <script>
                            setTimeout(() => {
                                window.print();
                            }, 500);
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            })
            .catch(error => {
                showNotification('Failed to load receipt data', 'error');
            });
    }
    
    // Helper functions
    function showEmptyState(message) {
        const tableSection = document.querySelector('.sales-table-section');
        const existingEmptyState = tableSection.querySelector('.empty-state');
        
        if (!existingEmptyState && salesTableBody.children.length > 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.innerHTML = `
                <i class="fas fa-search"></i>
                <h3>${message || 'No Results Found'}</h3>
                <p>Try adjusting your search criteria</p>
            `;
            tableSection.appendChild(emptyState);
        }
    }
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Add CSS for notifications
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    // Remove client-side pagination (since server handles it)
    document.getElementById('prevPage').style.display = 'none';
    document.getElementById('nextPage').style.display = 'none';
    document.querySelector('.pagination-pages').style.display = 'none';
    document.querySelector('.items-per-page').style.display = 'none';
});
</script>
{% endblock %}